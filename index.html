<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C1 Speaking Test â€“ Part 2</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    header { text-align: center; margin-bottom: 2rem; }
    header h1 { font-size: 1.6rem; font-weight: 700; color: #2b4a7e; }
    header p  { margin-top: 0.4rem; font-size: 0.95rem; color: #4a5568; }

    #main { width: 100%; max-width: 860px; }

    section { display: none; }
    section.active { display: block; }

    .step-label {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #718096;
      text-align: center;
      margin-bottom: 1.2rem;
    }

    /* â”€â”€ Section header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.2rem;
    }

    .section-header .step-label { margin-bottom: 0; }
    .header-actions { display: flex; gap: 0.5rem; }

    .action-btn {
      padding: 0.35rem 0.85rem;
      font-size: 0.82rem;
      font-weight: 600;
      border-radius: 7px;
      border: 2px solid #3182ce;
      background: #fff;
      color: #3182ce;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .action-btn:hover { background: #3182ce; color: #fff; }
    .action-btn:disabled { border-color: #a0aec0; color: #a0aec0; cursor: not-allowed; }
    .action-btn:disabled:hover { background: #fff; }

    /* â”€â”€ Generic choice cards (mode, role) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .choice-cards {
      display: flex;
      gap: 1.2rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .choice-card {
      flex: 1 1 220px;
      max-width: 300px;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 14px;
      padding: 2rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    }

    .choice-card:hover {
      border-color: #3182ce;
      box-shadow: 0 4px 16px rgba(49,130,206,0.15);
      transform: translateY(-3px);
    }

    .choice-card .card-icon { font-size: 2.6rem; margin-bottom: 0.7rem; }
    .choice-card h2 { font-size: 1rem; font-weight: 700; color: #2b4a7e; margin-bottom: 0.4rem; }
    .choice-card p  { font-size: 0.84rem; color: #718096; line-height: 1.45; }
    .choice-card .card-tag {
      display: inline-block;
      margin-top: 0.7rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: #2b6cb0;
      background: #ebf8ff;
      border-radius: 20px;
      padding: 2px 10px;
    }

    /* â”€â”€ Topic grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topics-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .topic-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 0.75rem 1rem;
      width: 110px;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.82rem;
      color: #2d3748;
      font-weight: 600;
      transition: border-color 0.2s, background 0.2s, transform 0.15s;
    }

    .topic-btn:hover { border-color: #3182ce; background: #ebf8ff; transform: translateY(-2px); }
    .topic-btn .emoji { font-size: 1.8rem; }

    /* â”€â”€ Image slots (upload & pick) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .slots {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1.2rem;
    }

    .slot {
      flex: 1 1 220px;
      max-width: 270px;
      height: 200px;
      border: 3px solid transparent;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background: #e2e8f0;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    }

    /* upload-mode */
    .slot.upload-mode {
      border: 2px dashed #90cdf4;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slot.upload-mode:hover { border-color: #3182ce; background: #ebf8ff; }
    .slot.upload-mode.filled { border-style: solid; border-color: #3182ce; }

    /* select-mode (pick section) */
    .slot.select-mode { cursor: pointer; }
    .slot.select-mode:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .slot.selected { border-color: #2b6cb0 !important; box-shadow: 0 0 0 4px #bee3f8; }

    /* loading skeleton */
    .slot.loading { cursor: default; border: none; }
    .slot.loading::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #e2e8f0 25%, #cbd5e0 50%, #e2e8f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
    }

    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .slot img {
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
      pointer-events: none;
      position: absolute;
      inset: 0;
    }

    .slot-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      pointer-events: none;
      z-index: 1;
    }

    .slot-placeholder svg { width: 40px; height: 40px; color: #90cdf4; }
    .slot-placeholder p   { font-size: 0.85rem; color: #718096; }

    .slot input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      z-index: 3;
    }

    /* check badge */
    .check-badge {
      position: absolute;
      top: 8px; right: 8px;
      width: 28px; height: 28px;
      background: #2b6cb0;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4;
    }

    .slot.selected .check-badge { display: flex; }

    .check-badge svg {
      width: 16px; height: 16px;
      stroke: #fff; fill: none;
      stroke-width: 2.5;
      stroke-linecap: round; stroke-linejoin: round;
    }

    /* change button (upload select mode) */
    .change-btn {
      position: absolute;
      bottom: 7px; right: 7px;
      background: rgba(0,0,0,0.55);
      border: none;
      border-radius: 6px;
      padding: 3px 7px;
      font-size: 0.72rem;
      color: #fff;
      cursor: pointer;
      display: none;
      z-index: 5;
    }

    .slot.upload-mode.filled .change-btn { display: block; }
    .change-btn:hover { background: rgba(0,0,0,0.75); }

    /* photo credit */
    .credit {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      padding: 4px 7px;
      background: rgba(0,0,0,0.45);
      font-size: 0.65rem;
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 2;
    }

    .credit a { color: inherit; text-decoration: underline; }

    /* â”€â”€ Counter & continue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .counter {
      text-align: center;
      font-size: 0.9rem;
      color: #718096;
      margin-bottom: 1rem;
    }

    .counter span { font-weight: 700; color: #2b6cb0; }

    .btn {
      display: block;
      margin: 0 auto;
      padding: 0.65rem 2rem;
      background: #2b6cb0;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:disabled { background: #a0aec0; cursor: not-allowed; }
    .btn:not(:disabled):hover { background: #2c5282; }
    .btn.hidden { visibility: hidden; }

    /* â”€â”€ Activity (1st candidate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .activity-images {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .activity-img {
      flex: 1 1 220px;
      max-width: 360px;
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .activity-img img {
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
    }

    .activity-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.4rem;
    }

    /* circular timer */
    .timer-wrap { position: relative; width: 120px; height: 120px; }

    .timer-svg { width: 120px; height: 120px; }

    #timer-ring {
      transition: stroke 0.5s;
      stroke: #48bb78;
    }

    #timer-text {
      font-size: 20px;
      font-weight: 700;
      font-family: 'Segoe UI', sans-serif;
      fill: #2d3748;
      transition: fill 0.5s;
    }

    /* recording dot */
    .rec-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #e53e3e;
      font-weight: 600;
    }

    .rec-dot {
      width: 11px; height: 11px;
      background: #e53e3e;
      border-radius: 50%;
      animation: pulse-dot 1.2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: 0.35; transform: scale(0.75); }
    }

    .stop-btn {
      background: #e53e3e;
      padding: 0.6rem 2.2rem;
      font-size: 1rem;
    }

    .stop-btn:hover { background: #c53030; }

    /* live transcript */
    .transcript-live {
      border-top: 1px solid #e2e8f0;
      padding-top: 1rem;
    }

    .transcript-label {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: #a0aec0;
      margin-bottom: 0.5rem;
    }

    .transcript-box {
      min-height: 60px;
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.92rem;
      color: #4a5568;
      line-height: 1.6;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
    }

    .transcript-box .interim { color: #a0aec0; }

    /* â”€â”€ Transcript result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-meta {
      font-size: 0.88rem;
      color: #718096;
      margin-bottom: 0.8rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .saved-badge {
      font-size: 0.78rem;
      font-weight: 700;
      color: #276749;
      background: #c6f6d5;
      border-radius: 20px;
      padding: 2px 10px;
    }

    .result-transcript-box {
      min-height: 120px;
      max-height: 300px;
      font-size: 1rem;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .result-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.2rem;
      flex-wrap: wrap;
    }

    .download-btn { background: #2f855a; }
    .download-btn:hover { background: #276749; }

    /* â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-msg {
      display: none;
      text-align: center;
      color: #c53030;
      font-size: 0.9rem;
      margin-bottom: 0.8rem;
    }

    /* â”€â”€ 2nd Candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .speaking-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: #2b6cb0;
      justify-content: center;
    }

    .speak-dot {
      width: 11px; height: 11px;
      background: #2b6cb0;
      border-radius: 50%;
      animation: pulse-dot 1.2s ease-in-out infinite;
    }

    .two-transcripts { display: flex; flex-direction: column; gap: 1.2rem; }

    .transcript-block-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #718096;
      margin-bottom: 0.4rem;
    }

    .skip-btn {
      background: #fff;
      border: 2px solid #3182ce;
      color: #3182ce;
      padding: 0.45rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .skip-btn:hover { background: #3182ce; color: #fff; }

    /* â”€â”€ Examiner prompt / answer box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .examiner-box {
      background: #ebf8ff;
      border: 1px solid #90cdf4;
      border-radius: 10px;
      padding: 1rem 1.2rem;
      font-size: 0.95rem;
      color: #2c5282;
      line-height: 1.65;
      margin-bottom: 1.2rem;
      min-height: 56px;
      overflow-y: auto;
      max-height: 160px;
    }

    .sub-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #3182ce;
      margin-bottom: 0.4rem;
    }

    /* â”€â”€ Examiner question (static, red-tinted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .question-box {
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 10px;
      padding: 0.9rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      color: #822727;
      line-height: 1.5;
      margin-bottom: 1.2rem;
      text-align: center;
    }
  </style>
</head>
<body>

<header>
  <h1>C1 Speaking Test &mdash; Part 2</h1>
  <p>Guided speaking activity preparation</p>
</header>

<div id="main">

  <!-- â‘  Mode selection -->
  <section id="mode-section" class="active">
    <p class="step-label">How would you like to get the images?</p>
    <div class="choice-cards">
      <div class="choice-card" id="mode-unsplash">
        <div class="card-icon">ğŸŒ</div>
        <h2>Unsplash images</h2>
        <p>Choose a topic and fetch themed photos automatically</p>
      </div>
      <div class="choice-card" id="mode-upload">
        <div class="card-icon">ğŸ“</div>
        <h2>My own images</h2>
        <p>Upload 3 photos from your device</p>
      </div>
    </div>
  </section>

  <!-- â‘¡ Unsplash: topic selection -->
  <section id="topic-section">
    <div class="section-header">
      <p class="step-label">Choose a topic</p>
      <div class="header-actions">
        <button class="action-btn" id="topic-back-btn">&#8592; Change mode</button>
      </div>
    </div>
    <div class="topics-grid" id="topics-grid"></div>
    <p class="error-msg" id="fetch-error">Could not load images. Check your connection and try again.</p>
  </section>

  <!-- â‘¢ Upload: upload 3 images -->
  <section id="upload-section">
    <div class="section-header">
      <p class="step-label" id="upload-label">Upload 3 images</p>
      <div class="header-actions">
        <button class="action-btn" id="upload-back-btn">&#8592; Change mode</button>
      </div>
    </div>
    <div class="slots" id="upload-slots"></div>
    <p class="counter" id="upload-counter">Uploaded: <span>0</span> / 3</p>
    <button class="btn hidden" id="upload-continue">Continue</button>
  </section>

  <!-- â‘£ Role selection -->
  <section id="role-section">
    <div class="section-header">
      <p class="step-label">Choose your role</p>
      <div class="header-actions">
        <button class="action-btn" id="role-back-btn">&#8592; Back</button>
      </div>
    </div>
    <div class="choice-cards">
      <div class="choice-card" id="role-first">
        <div class="card-icon">ğŸ—£ï¸</div>
        <h2>1st Candidate</h2>
        <p>Compare and contrast two photos, then answer a related question</p>
        <span class="card-tag">~1 minute</span>
      </div>
      <div class="choice-card" id="role-second">
        <div class="card-icon">ğŸ‘‚</div>
        <h2>2nd Candidate</h2>
        <p>Listen, then comment briefly on the same photos</p>
        <span class="card-tag">~30 seconds</span>
      </div>
    </div>
  </section>

  <!-- â‘¤ Display 2 images (2nd candidate â€” app's choice) -->
  <section id="display-section">
    <div class="section-header">
      <p class="step-label">Your two images</p>
      <div class="header-actions">
        <button class="action-btn" id="display-back-btn">&#8592; Change role</button>
      </div>
    </div>
    <div class="slots" id="display-slots"></div>
    <button class="btn" id="display-continue">Continue</button>
  </section>

  <!-- â‘¤-A Examiner prompt (2nd Candidate scenario) -->
  <section id="examiner-prompt-2nd-section">
    <div class="section-header">
      <p class="step-label">Examiner&rsquo;s task</p>
      <div class="header-actions">
        <button class="action-btn" id="ep2-back-btn">&#8592; Change role</button>
      </div>
    </div>

    <div class="activity-images" id="ep2-images"></div>

    <p class="sub-label">Examiner (to 1st Candidate)</p>
    <div class="examiner-box" id="ep2-prompt-box"></div>

    <div class="activity-controls" id="ep2-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="ep2-timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#4299e1" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="ep2-timer-text" x="50" y="57" text-anchor="middle"
                font-size="20" font-weight="700" font-family="'Segoe UI',sans-serif"
                fill="#2d3748">0:00</text>
        </svg>
      </div>
      <div class="speaking-header">
        <span class="speak-dot"></span>
        <span>Examiner speaking&hellip;</span>
      </div>
      <button class="skip-btn" id="ep2-skip-btn">Skip &#8594;</button>
    </div>

    <button class="btn hidden" id="ep2-continue-btn">Continue &#8594;</button>
  </section>

  <!-- â‘¥ Pick 2 images (1st candidate only) -->
  <section id="pick-section">
    <div class="section-header">
      <p class="step-label">Choose 2 images</p>
      <div class="header-actions">
        <button class="action-btn" id="pick-back-btn">&#8592; Change role</button>
      </div>
    </div>
    <div class="slots" id="pick-slots"></div>
    <p class="counter" id="pick-counter">Selected: <span>0</span> / 2</p>
    <button class="btn hidden" id="pick-continue" disabled>Continue</button>
  </section>

  <!-- â‘¦-A Examiner prompt (1st Candidate) -->
  <section id="examiner-prompt-section">
    <div class="section-header">
      <p class="step-label">Examiner&rsquo;s task</p>
      <div class="header-actions">
        <button class="action-btn" id="ep-back-btn">&#8592; Change images</button>
      </div>
    </div>

    <div class="activity-images" id="ep-images"></div>

    <p class="sub-label">Examiner</p>
    <div class="examiner-box" id="ep-prompt-box"></div>

    <div class="activity-controls" id="ep-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="ep-timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#4299e1" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="ep-timer-text" x="50" y="57" text-anchor="middle"
                font-size="20" font-weight="700" font-family="'Segoe UI',sans-serif"
                fill="#2d3748">0:00</text>
        </svg>
      </div>
      <div class="speaking-header">
        <span class="speak-dot"></span>
        <span>Examiner speaking&hellip;</span>
      </div>
      <button class="skip-btn" id="ep-skip-btn">Skip &#8594;</button>
    </div>

    <button class="btn hidden" id="ep-start-btn">&#9654; Start Speaking</button>
  </section>

  <!-- â‘§-B 2nd Candidate response (app) â€” after 1st candidate transcript -->
  <section id="second-answer-section">
    <div class="section-header">
      <p class="step-label">2nd Candidate &mdash; Response</p>
      <div class="header-actions"></div>
    </div>

    <div class="activity-images" id="sa-images"></div>

    <p class="sub-label">Examiner&rsquo;s question to 2nd candidate</p>
    <div class="question-box" id="sa-question-box"></div>

    <p class="sub-label">2nd Candidate (app)</p>
    <div class="examiner-box" id="sa-answer-box"></div>

    <div class="activity-controls" id="sa-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="sa-timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#4299e1" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="sa-timer-text" x="50" y="57" text-anchor="middle"
                font-size="20" font-weight="700" font-family="'Segoe UI',sans-serif"
                fill="#2d3748">0:00</text>
        </svg>
      </div>
      <div class="speaking-header">
        <span class="speak-dot"></span>
        <span>2nd Candidate speaking&hellip;</span>
      </div>
      <button class="skip-btn" id="sa-skip-btn">Skip &#8594;</button>
    </div>

    <button class="btn hidden" id="sa-continue-btn">Continue &#8594;</button>
  </section>

  <!-- â‘¦ 1st Candidate â€” speaking activity -->
  <section id="activity-first">
    <div class="section-header">
      <p class="step-label">1st Candidate &mdash; Speaking</p>
      <div class="header-actions">
        <button class="action-btn" id="activity-back-btn">&#8592; Change role</button>
      </div>
    </div>

    <div class="activity-images" id="activity-images"></div>
    <p class="error-msg" id="activity-error" style="margin-bottom:0.8rem"></p>

    <div class="activity-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#48bb78" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="timer-text" x="50" y="57" text-anchor="middle">0:00</text>
        </svg>
      </div>

      <div class="rec-status">
        <span class="rec-dot"></span>
        <span>Recordingâ€¦</span>
      </div>

      <button class="btn stop-btn" id="stop-btn">&#9209; Stop</button>
    </div>

    <div class="transcript-live">
      <p class="transcript-label">Live transcript</p>
      <div class="transcript-box" id="transcript-box">
        <span id="transcript-final"></span><span class="interim" id="transcript-interim"></span>
      </div>
    </div>
  </section>

  <!-- â‘§ Transcript result -->
  <section id="transcript-section">
    <div class="section-header">
      <p class="step-label">Your transcript</p>
      <div class="header-actions">
        <button class="action-btn" id="transcript-restart-btn">&#8635; Start again</button>
      </div>
    </div>
    <div class="result-meta">
      <span>Duration: <strong id="result-duration">â€”</strong></span>
      <span id="result-saved-badge" class="saved-badge" style="display:none">&#10003; Saved</span>
    </div>
    <div class="transcript-box result-transcript-box" id="result-transcript-text"></div>
    <div class="result-actions">
      <button class="btn download-btn" id="transcript-download-btn">&#8595; Download .txt</button>
      <button class="btn" id="transcript-continue-btn">Continue</button>
    </div>
  </section>

  <!-- â‘¨ 2nd Candidate â€” listening to app -->
  <section id="second-listening-section">
    <div class="section-header">
      <p class="step-label">2nd Candidate &mdash; Listen</p>
      <div class="header-actions">
        <button class="action-btn" id="listening-back-btn">&#8592; Change role</button>
      </div>
    </div>

    <div class="activity-images" id="listening-images"></div>

    <div class="activity-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="listen-timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#4299e1" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="listen-timer-text" x="50" y="57" text-anchor="middle"
                font-size="20" font-weight="700" font-family="'Segoe UI',sans-serif"
                fill="#2d3748">0:00</text>
        </svg>
      </div>

      <div class="speaking-header">
        <span class="speak-dot"></span>
        <span>1st Candidate is speaking&hellip;</span>
      </div>

      <button class="skip-btn" id="listen-skip-btn">Skip &#8594;</button>
    </div>

    <div class="transcript-live">
      <p class="transcript-label">1st Candidate transcript</p>
      <div class="transcript-box" id="listen-transcript-box"></div>
    </div>
  </section>

  <!-- â‘©-A Examiner's question to 2nd Candidate -->
  <section id="examiner-question-2nd-section">
    <div class="section-header">
      <p class="step-label">Examiner&rsquo;s question</p>
      <div class="header-actions"></div>
    </div>

    <div class="activity-images" id="eq2-images"></div>

    <p class="sub-label">Examiner (to you)</p>
    <div class="examiner-box" id="eq2-question-box"></div>

    <div class="activity-controls" id="eq2-controls">
      <div class="speaking-header">
        <span class="speak-dot"></span>
        <span>Examiner speaking&hellip;</span>
      </div>
      <button class="skip-btn" id="eq2-skip-btn">Skip &#8594;</button>
    </div>

    <button class="btn hidden" id="eq2-start-btn">&#9654; Start Speaking</button>
  </section>

  <!-- â‘© 2nd Candidate â€” user speaking -->
  <section id="second-speaking-section">
    <div class="section-header">
      <p class="step-label">2nd Candidate &mdash; Your turn</p>
      <div class="header-actions"></div>
    </div>

    <div class="activity-images" id="second-speaking-images"></div>
    <p class="error-msg" id="second-speaking-error"></p>

    <div class="activity-controls">
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="7"/>
          <circle id="second-timer-ring" cx="50" cy="50" r="42" fill="none"
                  stroke="#48bb78" stroke-width="7"
                  stroke-dasharray="263.89" stroke-dashoffset="263.89"
                  stroke-linecap="round" transform="rotate(-90 50 50)"/>
          <text id="second-timer-text" x="50" y="57" text-anchor="middle"
                font-size="20" font-weight="700" font-family="'Segoe UI',sans-serif"
                fill="#2d3748">0:30</text>
        </svg>
      </div>

      <div class="rec-status">
        <span class="rec-dot"></span>
        <span>Recording&hellip;</span>
      </div>

      <button class="btn stop-btn" id="second-stop-btn">&#9209; Stop</button>
    </div>

    <div class="transcript-live">
      <p class="transcript-label">Live transcript</p>
      <div class="transcript-box" id="second-transcript-box">
        <span id="second-transcript-final"></span><span class="interim" id="second-transcript-interim"></span>
      </div>
    </div>
  </section>

  <!-- â‘ª 2nd Candidate â€” session result -->
  <section id="second-result-section">
    <div class="section-header">
      <p class="step-label">Session complete</p>
      <div class="header-actions">
        <button class="action-btn" id="second-restart-btn">&#8635; Start again</button>
      </div>
    </div>

    <div class="result-meta">
      <span>App: <strong id="second-app-duration">â€”</strong></span>
      <span>You: <strong id="second-user-duration">â€”</strong></span>
      <span id="second-saved-badge" class="saved-badge" style="display:none">&#10003; Saved</span>
    </div>

    <div class="two-transcripts">
      <div>
        <p class="transcript-block-label">1st Candidate (app)</p>
        <div class="transcript-box result-transcript-box" id="second-app-transcript-text"></div>
      </div>
      <div>
        <p class="transcript-block-label">2nd Candidate (you)</p>
        <div class="transcript-box result-transcript-box" id="second-user-transcript-text"></div>
      </div>
    </div>

    <div class="result-actions">
      <button class="btn download-btn" id="second-download-btn">&#8595; Download .txt</button>
    </div>
  </section>

</div>

<script>
  const API_KEY = 'HNNl4DxhiNd3n4QeqFNk95pzwAEpiAKhqbiP4FvccZE';
  const TOTAL  = 3;
  const CHOOSE = 2;

  const TOPICS = [
    { label: 'Technology',    emoji: 'ğŸ’»', query: 'technology' },
    { label: 'Education',     emoji: 'ğŸ“š', query: 'education school' },
    { label: 'Environment',   emoji: 'ğŸŒ¿', query: 'environment nature' },
    { label: 'Health',        emoji: 'ğŸƒ', query: 'health fitness' },
    { label: 'Work',          emoji: 'ğŸ’¼', query: 'people working office' },
    { label: 'Travel',        emoji: 'âœˆï¸',  query: 'travel tourism' },
    { label: 'Food',          emoji: 'ğŸ½ï¸', query: 'food cooking' },
    { label: 'Sport',         emoji: 'âš½',  query: 'sport competition' },
    { label: 'Family',        emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', query: 'family together' },
    { label: 'City life',     emoji: 'ğŸ™ï¸', query: 'city urban life' },
    { label: 'Social media',  emoji: 'ğŸ“±', query: 'social media smartphone' },
    { label: 'Art & Culture', emoji: 'ğŸ¨', query: 'art culture museum' },
  ];

  // â”€â”€ Shared state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // allImages: array of 3 objects { src, creditHtml }
  let allImages    = [];
  let imageSource  = null;   // 'unsplash' | 'upload'
  let fetchPromise = null;   // pending Unsplash fetch

  // â”€â”€ Section helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showOnly(id) {
    document.querySelectorAll('#main section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODE SELECTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.getElementById('mode-unsplash').addEventListener('click', () => {
    imageSource = 'unsplash';
    allImages = [];
    fetchPromise = null;
    fetchError.style.display = 'none';
    showOnly('topic-section');
  });

  document.getElementById('mode-upload').addEventListener('click', () => {
    imageSource = 'upload';
    allImages = [];
    resetUpload();
    showOnly('upload-section');
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UNSPLASH FLOW
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let currentTopic = null;

  const topicsGrid  = document.getElementById('topics-grid');
  const fetchError  = document.getElementById('fetch-error');

  TOPICS.forEach(topic => {
    const btn = document.createElement('button');
    btn.className = 'topic-btn';
    btn.innerHTML = `<span class="emoji">${topic.emoji}</span>${topic.label}`;
    btn.addEventListener('click', () => onTopicSelected(topic));
    topicsGrid.appendChild(btn);
  });

  document.getElementById('topic-back-btn').addEventListener('click', () => {
    fetchPromise = null;
    showOnly('mode-section');
  });

  async function onTopicSelected(topic) {
    currentTopic = topic;
    allImages = [];
    fetchError.style.display = 'none';

    // Disable topic buttons while loading
    topicsGrid.querySelectorAll('.topic-btn').forEach(b => b.disabled = true);

    fetchPromise = fetchImages(topic.query);
    const ok = await fetchPromise;

    topicsGrid.querySelectorAll('.topic-btn').forEach(b => b.disabled = false);

    if (ok) showOnly('role-section');
  }

  async function fetchImages(query) {
    try {
      const url = `https://api.unsplash.com/photos/random?query=${encodeURIComponent(query)}&count=${TOTAL}&client_id=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`API error ${res.status}`);
      const data = await res.json();
      allImages = data.map(p => ({
        src: p.urls.regular,
        creditHtml: `Photo by <a href="${p.user.links.html}?utm_source=c1_test_app&utm_medium=referral" target="_blank" rel="noopener">${p.user.name}</a> on <a href="${p.links.html}?utm_source=c1_test_app&utm_medium=referral" target="_blank" rel="noopener">Unsplash</a>`,
      }));
      return true;
    } catch (err) {
      fetchError.style.display = 'block';
      console.error(err);
      return false;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPLOAD FLOW
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const uploadSlotsEl  = document.getElementById('upload-slots');
  const uploadCounter  = document.getElementById('upload-counter');
  const uploadLabel    = document.getElementById('upload-label');
  const uploadedImages = new Array(TOTAL).fill(null);

  document.getElementById('upload-back-btn').addEventListener('click', () => showOnly('mode-section'));

  function resetUpload() {
    uploadedImages.fill(null);
    uploadLabel.textContent = 'Upload 3 images';
    uploadCounter.innerHTML = `Uploaded: <span>0</span> / ${TOTAL}`;
    uploadContinue.classList.add('hidden');
    buildUploadSlots();
  }

  function buildUploadSlots() {
    uploadSlotsEl.innerHTML = '';
    for (let i = 0; i < TOTAL; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot upload-mode';
      slot.innerHTML = `
        <div class="slot-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
               stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021
                 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
          </svg>
          <p>Upload image</p>
        </div>
        <button class="change-btn">Change</button>
        <input type="file" accept="image/*" />
      `;
      uploadSlotsEl.appendChild(slot);

      const fileInput = slot.querySelector('input[type="file"]');
      const changeBtn = slot.querySelector('.change-btn');

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          uploadedImages[i] = ev.target.result;
          setSlotImage(slot, ev.target.result);
          onUploadChange();
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      changeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.click();
      });
    }
  }

  function setSlotImage(slot, src) {
    slot.classList.add('filled');
    let img = slot.querySelector('img');
    if (!img) {
      img = document.createElement('img');
      slot.insertBefore(img, slot.querySelector('.change-btn'));
    }
    img.src = src;
    slot.querySelector('.slot-placeholder').style.display = 'none';
  }

  const uploadContinue = document.getElementById('upload-continue');
  uploadContinue.addEventListener('click', () => showOnly('role-section'));

  function onUploadChange() {
    const count = uploadedImages.filter(Boolean).length;
    uploadCounter.innerHTML = `Uploaded: <span>${count}</span> / ${TOTAL}`;
    if (count === TOTAL) {
      allImages = uploadedImages.map(src => ({ src, creditHtml: null }));
      uploadContinue.classList.remove('hidden');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ROLE SELECTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.getElementById('role-back-btn').addEventListener('click', () => {
    if (imageSource === 'unsplash') showOnly('topic-section');
    else showOnly('upload-section');
  });

  document.getElementById('role-first').addEventListener('click', () => {
    showPickSection();
  });

  document.getElementById('role-second').addEventListener('click', () => {
    const indices = randomTwo();
    const chosen = indices.map(i => allImages[i]);
    showDisplaySection(chosen);
  });

  function randomTwo() {
    const indices = [0, 1, 2];
    // Fisher-Yates shuffle, take first 2
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    return indices.slice(0, CHOOSE);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DISPLAY SECTION (2nd candidate â€” shows the 2 randomly picked images)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const displaySlotsEl = document.getElementById('display-slots');
  let displayChosen    = [];

  document.getElementById('display-back-btn').addEventListener('click', () => showOnly('role-section'));

  document.getElementById('display-continue').addEventListener('click', () => {
    showExaminerPrompt2nd(displayChosen);
  });

  function showDisplaySection(chosen) {
    displayChosen = chosen;
    displaySlotsEl.innerHTML = '';

    chosen.forEach((img, i) => {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.innerHTML = `
        <img src="${img.src}" alt="Image ${i + 1}" loading="lazy" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}
      `;
      displaySlotsEl.appendChild(slot);
    });

    showOnly('display-section');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PICK SECTION (1st candidate)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const pickSlotsEl  = document.getElementById('pick-slots');
  const pickCounter  = document.getElementById('pick-counter');
  const pickContinue = document.getElementById('pick-continue');
  let pickSelected   = new Set();

  document.getElementById('pick-back-btn').addEventListener('click', () => showOnly('role-section'));

  function showPickSection() {
    pickSelected.clear();
    pickCounter.innerHTML = `Selected: <span>0</span> / ${CHOOSE}`;
    pickContinue.classList.add('hidden');
    pickContinue.disabled = true;
    pickSlotsEl.innerHTML = '';

    allImages.forEach((img, i) => {
      const slot = document.createElement('div');
      slot.className = 'slot select-mode';
      slot.innerHTML = `
        <img src="${img.src}" alt="Image ${i + 1}" loading="lazy" />
        <div class="check-badge">
          <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}
      `;
      slot.addEventListener('click', () => pickToggle(slot, i));
      pickSlotsEl.appendChild(slot);
    });

    showOnly('pick-section');
  }

  function pickToggle(slot, index) {
    if (pickSelected.has(index)) {
      pickSelected.delete(index);
      slot.classList.remove('selected');
    } else {
      if (pickSelected.size >= CHOOSE) return;
      pickSelected.add(index);
      slot.classList.add('selected');
    }
    pickCounter.innerHTML = `Selected: <span>${pickSelected.size}</span> / ${CHOOSE}`;
    const ready = pickSelected.size === CHOOSE;
    pickContinue.disabled = !ready;
    if (ready) pickContinue.classList.remove('hidden');
  }

  pickContinue.addEventListener('click', () => {
    const chosen = [...pickSelected].map(i => allImages[i]);
    showExaminerPromptSection(chosen);
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXAMINER PROMPT SECTION  (â‘¦-A â€” 1st Candidate)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let firstChosenImages = [];   // persists through transcript â†’ second-answer

  const epTimerRing = document.getElementById('ep-timer-ring');
  const epTimerText = document.getElementById('ep-timer-text');
  const epPromptBox = document.getElementById('ep-prompt-box');
  const epStartBtn  = document.getElementById('ep-start-btn');

  let epUtterance     = null;
  let epTimerInterval = null;
  let epSeconds       = 0;

  document.getElementById('ep-back-btn').addEventListener('click', () => {
    stopEpSpeech();
    showOnly('pick-section');
  });

  document.getElementById('ep-skip-btn').addEventListener('click', () => {
    stopEpSpeech();
    epPromptBox.textContent = getExaminerPrompt(currentTopic).task;
    revealEpStartBtn();
  });

  epStartBtn.addEventListener('click', () => {
    startFirstCandidateActivity(firstChosenImages);
  });

  function showExaminerPromptSection(chosen) {
    firstChosenImages = chosen;
    const data = getExaminerPrompt(currentTopic);

    const epImages = document.getElementById('ep-images');
    epImages.innerHTML = '';
    chosen.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      epImages.appendChild(div);
    });

    epSeconds = 0;
    epPromptBox.textContent = '';
    epTimerRing.style.strokeDashoffset = CIRCUMFERENCE;
    epTimerRing.style.stroke = '#4299e1';
    epTimerText.textContent = '0:00';
    epStartBtn.classList.add('hidden');
    document.getElementById('ep-controls').style.display = '';
    document.getElementById('ep-skip-btn').style.display = '';
    document.querySelector('#examiner-prompt-section .speaking-header').style.display = '';

    showOnly('examiner-prompt-section');
    startEpSpeech(data.task);
  }

  function startEpSpeech(text) {
    if (!window.speechSynthesis) {
      epPromptBox.textContent = text + '\n\n(Text-to-speech not supported â€” read the prompt above and click Skip.)';
      revealEpStartBtn();
      return;
    }

    epTimerInterval = setInterval(() => {
      epSeconds++;
      const m = Math.floor(epSeconds / 60);
      const s = epSeconds % 60;
      epTimerText.textContent = `${m}:${s.toString().padStart(2, '0')}`;
      epTimerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - Math.min(epSeconds / 60, 1));
    }, 1000);

    epUtterance = new SpeechSynthesisUtterance(text);
    epUtterance.lang  = 'en-GB';
    epUtterance.rate  = 0.95;

    const assignVoice = () => {
      const voices = window.speechSynthesis.getVoices();
      const voice  = voices.find(v => v.lang === 'en-GB' && v.name.toLowerCase().includes('google'))
                  || voices.find(v => v.lang === 'en-GB')
                  || voices.find(v => v.lang.startsWith('en'));
      if (voice) epUtterance.voice = voice;
    };
    if (window.speechSynthesis.getVoices().length) assignVoice();
    else window.speechSynthesis.onvoiceschanged = () => { assignVoice(); window.speechSynthesis.onvoiceschanged = null; };

    epUtterance.onboundary = (e) => {
      if (e.name === 'word') {
        epPromptBox.textContent = text.slice(0, e.charIndex + (e.charLength || 1));
        epPromptBox.scrollTop = epPromptBox.scrollHeight;
      }
    };
    epUtterance.onend = () => {
      clearInterval(epTimerInterval); epTimerInterval = null;
      epPromptBox.textContent = text;
      revealEpStartBtn();
    };
    epUtterance.onerror = (e) => {
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      clearInterval(epTimerInterval); epTimerInterval = null;
      epPromptBox.textContent = text;
      revealEpStartBtn();
    };

    window.speechSynthesis.speak(epUtterance);
  }

  function stopEpSpeech() {
    clearInterval(epTimerInterval); epTimerInterval = null;
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    epUtterance = null;
  }

  function revealEpStartBtn() {
    document.getElementById('ep-controls').style.display = 'none';
    epStartBtn.classList.remove('hidden');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECOND ANSWER SECTION  (â‘§-B â€” app as 2nd Candidate)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const saTimerRing   = document.getElementById('sa-timer-ring');
  const saTimerText   = document.getElementById('sa-timer-text');
  const saAnswerBox   = document.getElementById('sa-answer-box');
  const saContinueBtn = document.getElementById('sa-continue-btn');
  const SA_LIMIT      = 30;

  let saUtterance     = null;
  let saTimerInterval = null;
  let saSeconds       = 0;

  document.getElementById('sa-skip-btn').addEventListener('click', () => {
    stopSaSpeech();
    saAnswerBox.textContent = getExaminerPrompt(currentTopic).answer2nd;
    revealSaContinueBtn();
  });

  saContinueBtn.addEventListener('click', () => {
    alert('Assessment â€” coming soon.');
  });

  function showSecondAnswerSection() {
    const data = getExaminerPrompt(currentTopic);
    saSeconds = 0;

    const saImages = document.getElementById('sa-images');
    saImages.innerHTML = '';
    firstChosenImages.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      saImages.appendChild(div);
    });

    document.getElementById('sa-question-box').textContent = data.question2nd;
    saAnswerBox.textContent = '';
    saTimerRing.style.strokeDashoffset = CIRCUMFERENCE;
    saTimerRing.style.stroke = '#4299e1';
    saTimerText.textContent = '0:00';
    saContinueBtn.classList.add('hidden');
    document.getElementById('sa-controls').style.display = '';
    document.getElementById('sa-skip-btn').style.display = '';
    document.querySelector('#second-answer-section .speaking-header').style.display = '';

    showOnly('second-answer-section');
    startSaSpeech(data.answer2nd);
  }

  function startSaSpeech(text) {
    if (!window.speechSynthesis) {
      saAnswerBox.textContent = text + '\n\n(Text-to-speech not supported â€” read the response above and click Skip.)';
      revealSaContinueBtn();
      return;
    }

    saTimerInterval = setInterval(() => {
      saSeconds++;
      const m = Math.floor(saSeconds / 60);
      const s = saSeconds % 60;
      saTimerText.textContent = `${m}:${s.toString().padStart(2, '0')}`;
      saTimerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - Math.min(saSeconds / SA_LIMIT, 1));
    }, 1000);

    saUtterance = new SpeechSynthesisUtterance(text);
    saUtterance.lang = 'en-GB';
    saUtterance.rate = 0.95;

    const assignVoice = () => {
      const voices = window.speechSynthesis.getVoices();
      const voice  = voices.find(v => v.lang === 'en-GB' && v.name.toLowerCase().includes('google'))
                  || voices.find(v => v.lang === 'en-GB')
                  || voices.find(v => v.lang.startsWith('en'));
      if (voice) saUtterance.voice = voice;
    };
    if (window.speechSynthesis.getVoices().length) assignVoice();
    else window.speechSynthesis.onvoiceschanged = () => { assignVoice(); window.speechSynthesis.onvoiceschanged = null; };

    saUtterance.onboundary = (e) => {
      if (e.name === 'word') {
        saAnswerBox.textContent = text.slice(0, e.charIndex + (e.charLength || 1));
        saAnswerBox.scrollTop = saAnswerBox.scrollHeight;
      }
    };
    saUtterance.onend = () => {
      clearInterval(saTimerInterval); saTimerInterval = null;
      saAnswerBox.textContent = text;
      revealSaContinueBtn();
    };
    saUtterance.onerror = (e) => {
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      clearInterval(saTimerInterval); saTimerInterval = null;
      saAnswerBox.textContent = text;
      revealSaContinueBtn();
    };

    window.speechSynthesis.speak(saUtterance);
  }

  function stopSaSpeech() {
    clearInterval(saTimerInterval); saTimerInterval = null;
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    saUtterance = null;
  }

  function revealSaContinueBtn() {
    document.getElementById('sa-controls').style.display = 'none';
    saContinueBtn.classList.remove('hidden');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HAND-OFF TO ACTIVITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function onActivityReady(role, chosenImages) {
    if (role === '1st') startFirstCandidateActivity(chosenImages);
    else startSecondCandidateActivity(chosenImages);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1ST CANDIDATE ACTIVITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SOFT_LIMIT    = 60;                          // seconds
  const CIRCUMFERENCE = 263.89;                      // 2Ï€Ã—42

  const activityImages  = document.getElementById('activity-images');
  const timerRing       = document.getElementById('timer-ring');
  const timerText       = document.getElementById('timer-text');
  const stopBtn         = document.getElementById('stop-btn');
  const transcriptFinal = document.getElementById('transcript-final');
  const transcriptInterim = document.getElementById('transcript-interim');
  const transcriptBox   = document.getElementById('transcript-box');

  let timerInterval   = null;
  let secondsElapsed  = 0;
  let mediaRecorder   = null;
  let micStream       = null;   // kept separately to reliably stop mic tracks
  let audioChunks     = [];
  let finalTranscript = '';
  let recognition     = null;

  document.getElementById('activity-back-btn').addEventListener('click', () => {
    stopActivity(false);          // stop everything but don't navigate to transcript
    showOnly('role-section');
  });

  async function startFirstCandidateActivity(images) {
    // Reset state
    secondsElapsed  = 0;
    finalTranscript = '';
    audioChunks     = [];
    transcriptFinal.textContent   = '';
    transcriptInterim.textContent = '';
    updateTimerDisplay();

    // Populate images
    activityImages.innerHTML = '';
    images.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      activityImages.appendChild(div);
    });

    // Reset timer ring colour from any previous session
    timerRing.style.stroke = '#48bb78';
    timerText.style.fill   = '#2d3748';

    const activityError = document.getElementById('activity-error');
    activityError.style.display = 'none';

    showOnly('activity-first');

    // Start microphone + recording
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
    } catch (err) {
      activityError.textContent = `Microphone error: ${err.message} â€” please allow microphone access and try again.`;
      activityError.style.display = 'block';
    }

    // Start speech recognition (transcription)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
      recognition = new SR();
      recognition.lang = 'en-GB';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + ' ';
          else interim += e.results[i][0].transcript;
        }
        transcriptFinal.textContent   = finalTranscript;
        transcriptInterim.textContent = interim;
        transcriptBox.scrollTop = transcriptBox.scrollHeight;
      };

      recognition.onerror = (e) => {
        // 'aborted' fires normally when we call recognition.stop() â€” ignore it
        if (e.error === 'aborted') return;
        activityError.textContent = `Transcription error: "${e.error}". Try using Chrome or Edge, and ensure the page is served over HTTPS or localhost.`;
        activityError.style.display = 'block';
      };
      recognition.onend = () => { if (timerInterval) recognition.start(); };
      recognition.start();
    } else {
      transcriptFinal.textContent = '(Speech recognition not supported â€” use Chrome or Edge)';
    }

    // Start timer
    timerInterval = setInterval(() => {
      secondsElapsed++;
      updateTimerDisplay();
    }, 1000);

    stopBtn.onclick = () => stopActivity(true);
  }

  function updateTimerDisplay() {
    const mins = Math.floor(secondsElapsed / 60);
    const secs = secondsElapsed % 60;
    timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

    const progress = Math.min(secondsElapsed / SOFT_LIMIT, 1);
    timerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - progress);

    if (secondsElapsed >= SOFT_LIMIT) {
      timerRing.style.stroke = '#fc8181';
      timerText.style.fill   = '#e53e3e';
    } else if (secondsElapsed >= SOFT_LIMIT * 0.8) {
      timerRing.style.stroke = '#f6ad55';
      timerText.style.fill   = '#dd6b20';
    }
  }

  function stopActivity(showResult = false) {
    // 1. Stop timer
    clearInterval(timerInterval);
    timerInterval = null;

    // 2. Stop speech recognition (prevent auto-restart first)
    if (recognition) {
      recognition.onend = null;
      recognition.stop();
      recognition = null;
    }
    transcriptInterim.textContent = '';

    // 3. Stop MediaRecorder
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      mediaRecorder = null;
    }

    // 4. Stop all microphone tracks â€” this closes the browser mic indicator
    if (micStream) {
      micStream.getTracks().forEach(t => t.stop());
      micStream = null;
    }

    // 5. Optionally navigate to transcript result
    if (showResult) showTranscriptResult();
  }

  document.getElementById('transcript-restart-btn').addEventListener('click', () => showOnly('mode-section'));
  document.getElementById('transcript-continue-btn').addEventListener('click', () => {
    showSecondAnswerSection();
  });

  function showTranscriptResult() {
    const text     = finalTranscript.trim() || '(No speech detected)';
    const duration = `${Math.floor(secondsElapsed / 60)}:${String(secondsElapsed % 60).padStart(2, '0')}`;
    const date     = new Date().toISOString();

    document.getElementById('result-transcript-text').textContent = text;
    document.getElementById('result-duration').textContent = duration;

    // â”€â”€ Save to LocalStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STORAGE_KEY = 'c1_transcripts';
    const entry = { date, duration, transcript: text };
    try {
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      existing.push(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
      document.getElementById('result-saved-badge').style.display = 'inline-block';
    } catch (e) {
      console.warn('Could not save to LocalStorage:', e);
    }

    // â”€â”€ Download button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('transcript-download-btn').onclick = () => {
      const content  = `C1 Speaking Test â€“ Part 2\nDate: ${new Date(date).toLocaleString()}\nDuration: ${duration}\n\n${text}`;
      const blob     = new Blob([content], { type: 'text/plain' });
      const url      = URL.createObjectURL(blob);
      const a        = document.createElement('a');
      a.href         = url;
      a.download     = `c1_transcript_${date.slice(0, 10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };

    showOnly('transcript-section');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2ND CANDIDATE ACTIVITY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SECOND_LISTEN_LIMIT = 60;
  const SECOND_SPEAK_LIMIT  = 30;

  const SPEECHES = {
    'technology': `Both photographs centre on the theme of technology, though they capture it in very different contexts. The first image appears to show technology in a personal, everyday setting â€” perhaps someone using a device at home or in a relaxed environment. The second photograph, by contrast, places technology in a more professional or public context, suggesting how it shapes our working lives and social interactions. What strikes me most is how differently we relate to technology depending on the situation. In the first image, it seems to be a source of comfort or entertainment; in the second, it feels more purposeful â€” even indispensable. This raises an interesting question about whether technology serves us or whether, increasingly, we serve it. I think both images together highlight how deeply technology has embedded itself in every aspect of modern life, for better or worse.`,

    'education school': `These two photographs both explore what learning looks like, but from quite different angles. The first seems to depict a formal, structured educational setting â€” a classroom or lecture environment where instruction follows a clear, traditional format. The second image suggests a more informal approach: perhaps a workshop, an outdoor activity, or some form of experiential learning. What I find interesting is the contrast in atmosphere. The first conveys order and discipline, which undoubtedly has value in terms of consistency and academic rigour. The second, however, feels more dynamic and student-centred, suggesting that engagement and relevance can sometimes matter more than structure. Modern education increasingly tries to combine both approaches, recognising that different learners thrive in different environments. I personally believe the most effective learning happens when both challenge and curiosity are present at the same time.`,

    'environment nature': `Both images relate to the environment, but they seem to tell very different stories. The first photograph appears to show the natural world at its most striking â€” perhaps a landscape, a wild setting, or an ecosystem relatively untouched by human activity. The second image, on the other hand, brings in the human dimension: possibly urban development, pollution, or some form of environmental disruption. What I find powerful about this pairing is the implicit contrast between what the natural world can look like and what it increasingly has to contend with. Neither image is neutral â€” both invite a kind of reflection on our relationship with the planet. I think the tension between these two photographs captures something essential about the environmental debate: the beauty we stand to lose, and the choices that will determine whether we lose it.`,

    'health fitness': `Both images connect to the theme of health and wellbeing, though they approach it differently. The first photograph seems to focus on physical activity â€” exercise, sport, or some form of movement that represents the more visible, measurable side of health. The second image appears to capture a different dimension: perhaps rest, mental wellbeing, or a quieter kind of self-care. What I find striking is how these two images together challenge the narrow view of health as simply fitness or physical appearance. True wellbeing, as we increasingly understand it, involves balance â€” between effort and recovery, between body and mind. Modern life can push people towards the performance-focused model in the first image, sometimes at the expense of what the second image represents. Both have value, and I think the most sustainable approach to health draws on elements of both.`,

    'people working office': `Both photographs relate to the world of work, but they capture it from quite different perspectives. The first image appears to depict a conventional professional setting â€” an office or structured environment where people come together in a shared physical space. The second photograph hints at a more flexible or modern approach: perhaps remote working, an informal setting, or a non-traditional professional context. This contrast feels particularly significant given how dramatically work culture has shifted in recent years. The traditional model offers clear boundaries, face-to-face collaboration, and a defined structure to the working day. The more flexible model, meanwhile, offers autonomy and freedom, though it can blur the lines between work and personal life. I believe neither model is universally better â€” the best approach depends on the individual, the role, and what environment brings out the best in each person.`,

    'travel tourism': `Both images connect to the theme of travel, though they seem to represent quite different travel experiences. The first photograph appears to capture the iconic side of travel â€” famous landmarks, dramatic landscapes, or the kind of image that ends up on a postcard. The second image feels more personal or intimate, perhaps focusing on local life, cultural interaction, or the quieter moments that define a journey. I think this distinction gets at something important about what we expect travel to do for us. The first kind of travel is about spectacle and experience â€” ticking things off, capturing memories. The second is more about understanding: encountering different ways of living and seeing the world from a new perspective. Most travellers want both, but I think the most meaningful trips tend to lean towards the second, even if the first is what draws us there initially.`,

    'food cooking': `Both photographs explore the theme of food, but in very different ways. The first image appears to focus on the preparation side â€” cooking at home, perhaps, or some kind of craft involved in putting a meal together. The second photograph seems to capture the social dimension: eating out, sharing food, or experiencing it as part of a wider cultural or communal event. What I find interesting is how food is rarely ever just about nutrition. Whether we're cooking or dining, food is deeply bound up with identity, care, and connection. The first image suggests something personal and intentional â€” a choice to invest time in the act of eating well. The second suggests something more outward-looking: food as a way of experiencing other cultures or simply coming together. I think both images remind us that our relationship with food says a great deal about how we live.`,

    'sport competition': `These two photographs both deal with sport, but they highlight very different aspects of what sport means and who it is for. The first image appears to focus on competition â€” perhaps a race, a match, or a high-pressure moment where performance and winning are at stake. The second photograph seems to capture a more recreational or community-oriented side of sport, where the emphasis is on participation, enjoyment, and social connection. I find this distinction really valuable. Elite competitive sport is inspiring â€” it sets standards, generates passion, and makes sport feel aspirational. But recreational sport arguably does more for everyday wellbeing, encouraging active lifestyles and bringing people together regardless of ability. A healthy sporting culture, I'd argue, makes room for both: it uses the excitement of competition to inspire participation, while keeping the barriers to entry as low as possible.`,

    'family together': `Both photographs relate to family life, though they seem to capture it in quite different ways. The first image appears to depict a more formal or structured family setting â€” perhaps a significant occasion, a staged moment, or an image centred on togetherness and tradition. The second photograph feels more candid, showing family life as it actually is: unscripted, perhaps a little chaotic, but warm and authentic. What I find interesting is how these two images reflect different ideas about what family means. The first speaks to the rituals and roles that give families their shape â€” shared events and values that create continuity across generations. The second captures something more immediate: the daily reality of living alongside the people closest to you. I think families need their rituals, but the truest moments of connection often happen in the unplanned, ordinary spaces in between.`,

    'city urban life': `Both photographs explore urban life, but they seem to focus on quite different aspects of the city experience. The first image appears to capture the energy and density of city living â€” the crowds, the pace, the sense that something is always happening. The second photograph seems to offer a more intimate or human-scale view: a neighbourhood, a quiet street, or a public space that feels lived-in and local. I find this contrast at the heart of what makes cities both exciting and challenging. The energy of the first image is what draws people to cities in the first place: opportunity, diversity, stimulation. But it can also feel overwhelming or impersonal. The second image suggests that what makes a city truly liveable is not just its scale or vibrancy, but the quality of the everyday spaces where people actually spend their lives.`,

    'social media smartphone': `Both photographs relate to digital life and social media, though they seem to approach the subject from different angles. The first image appears to show someone deeply absorbed in their device â€” connected, perhaps, but also somewhat withdrawn from the world around them. The second photograph seems to explore either the positive side of digital communication, or the contrast between online and offline life. What makes this pairing interesting is the ambiguity it creates. Social media and smartphones are genuinely powerful tools for connection, creativity, and access to information. But the way we use them can also reinforce isolation, distract us from meaningful engagement, and affect our wellbeing in subtle ways. I don't think either image tells a simple story. What they do together is ask us to reflect on how consciously we're choosing to use these tools â€” and who, ultimately, is in control.`,

    'art culture museum': `Both images connect to the theme of art and culture, but they represent it in quite different ways. The first photograph appears to focus on culture in an institutional setting â€” perhaps a museum, a gallery, or a formal performance space where art is preserved, curated, and presented to the public. The second image seems to capture something more grassroots or spontaneous: art in public spaces, or culture as something lived and experienced outside established venues. This distinction reflects a genuine tension within the cultural world. Institutions play a vital role in conserving heritage and providing access to significant works. But art also needs to break free of those boundaries â€” to meet people where they are and reflect the world as it is now. I believe the most vibrant cultural scenes find a way to honour both: the weight of tradition and the vitality of the present moment.`,
  };

  const SPEECH_FALLBACK = `Looking at these two photographs, what strikes me immediately is how differently they approach what seems to be a shared theme. The first image draws the eye to a particular atmosphere â€” there's something very specific about its mood and composition that invites reflection. The second photograph feels like a counterpoint: it takes a related subject but presents it from a quite different angle, in terms of setting, tone, or what it suggests about the people involved. What I find interesting is that neither image tells a complete story on its own â€” it's the comparison that creates meaning. Together, they highlight contrasts that go beyond the purely visual: differences in mood, perhaps, or in what kind of life each image implies. I'd say the second feels slightly more thought-provoking to me, though both raise questions I'd genuinely want to explore in more depth.`;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXAMINER PROMPTS â€” task (to 1st candidate) + Q&A (to/from 2nd)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const EXAMINER_PROMPTS = {
    'technology': {
      task: `Here are your two photographs. They both show people using technology in different contexts. I'd like you to compare and contrast these photographs, and say how technology is changing the way people live and work.`,
      question2nd: `Which of these ways of using technology do you think has had a more positive impact on people's everyday lives?`,
      answer2nd: `I think the more personal, individual use of technology has the greater positive impact, because it gives people genuine control over their own time and learning. Technology in a professional setting drives efficiency, but it can also create pressure and dependency. On balance, tools that people use on their own terms â€” to connect, create, or learn â€” tend to enrich life in ways that feel more meaningful and sustainable in the long run.`,
    },
    'education school': {
      task: `Here are your two photographs. They both relate to education and learning, but in quite different settings. I'd like you to compare and contrast these photographs, and say what you think makes a learning environment truly effective.`,
      question2nd: `Which of these learning environments do you think would suit most students better, and why?`,
      answer2nd: `I'd say most students would benefit from a blend of both, but the more structured setting probably provides the better foundation. Clear expectations and a consistent routine help learners build confidence and discipline. That said, the more experiential approach is crucial for deeper engagement and retention. The most effective education combines both: structure provides the framework, while hands-on or collaborative activities make learning genuinely stick over time.`,
    },
    'environment nature': {
      task: `Here are your two photographs. They both relate to the natural world, but they seem to tell quite different stories. I'd like you to compare and contrast these photographs, and say what you think people and societies can do to better protect the environment.`,
      question2nd: `Do you think individuals or governments bear greater responsibility for protecting the environment?`,
      answer2nd: `I believe governments have the greater responsibility, because systemic change â€” through regulation, investment, and international agreements â€” can achieve what individual action simply cannot at scale. Individual choices do matter: they shape demand and send important cultural signals. But the most effective approach combines both, with governments setting ambitious targets and creating the conditions that make sustainable choices easier and more affordable for ordinary people.`,
    },
    'health fitness': {
      task: `Here are your two photographs. They both connect to health and wellbeing, but they approach it in quite different ways. I'd like you to compare and contrast these photographs, and say how important you think it is to maintain a healthy lifestyle in modern life.`,
      question2nd: `Do you think modern life makes it easier or harder to stay healthy compared to previous generations?`,
      answer2nd: `Modern life makes it significantly harder for most people, despite giving us better health information than ever before. Long working hours, sedentary jobs, processed food, and constant digital distraction all work against healthy habits. Awareness alone isn't enough when the environment pulls in the opposite direction. That said, for those with time and resources, modern tools genuinely support healthier choices, which highlights how much health is shaped by social and economic inequality.`,
    },
    'people working office': {
      task: `Here are your two photographs. They both show people in professional settings, but in quite different environments. I'd like you to compare and contrast these photographs, and say how you think the nature of work is changing.`,
      question2nd: `Do you think remote working is generally better or worse for productivity than working in an office?`,
      answer2nd: `The honest answer is that it depends heavily on the individual and the role. Remote working clearly boosts productivity for tasks requiring deep, focused concentration, and it eliminates commuting time entirely. But collaborative, creative work often suffers without face-to-face interaction. What the shift to remote working has revealed is that the traditional office model assumed everyone worked the same way â€” and that assumption was never entirely correct.`,
    },
    'travel tourism': {
      task: `Here are your two photographs. They both relate to travel and tourism, but they capture quite different kinds of experience. I'd like you to compare and contrast these photographs, and say how you think travel benefits people.`,
      question2nd: `Do you think mass tourism does more harm than good to the places people visit?`,
      answer2nd: `On balance, I think mass tourism often does more harm than good to the specific locations where it concentrates. It can damage fragile ecosystems, price out local residents, and gradually erode the very culture that attracted visitors in the first place. The economic benefits are real, but they're frequently unevenly distributed. Smaller-scale, sustainable tourism that genuinely supports local communities is a far better model, even if it's harder to organise on a large scale.`,
    },
    'food cooking': {
      task: `Here are your two photographs. They both explore the theme of food, but in quite different ways. I'd like you to compare and contrast these photographs, and say how important you think food and food culture are in people's lives.`,
      question2nd: `Do you think people today have a healthier or unhealthier relationship with food than previous generations?`,
      answer2nd: `It's genuinely mixed. We have far greater awareness of nutrition and access to a much wider variety of foods. But ultra-processed food is everywhere, and diet culture has made many people anxious about eating in ways that aren't psychologically healthy. I think previous generations had a simpler, more intuitive relationship with food â€” cooking from scratch, eating together, wasting far less. We've gained nutritional knowledge but arguably lost a kind of everyday food wisdom.`,
    },
    'sport competition': {
      task: `Here are your two photographs. They both relate to sport, but they seem to focus on different aspects of what sport means. I'd like you to compare and contrast these photographs, and say what role you think sport plays in society.`,
      question2nd: `Do you think competitive sport builds character, or does it put too much pressure on young people?`,
      answer2nd: `I think it does both, and the balance depends on how it's managed. At its best, competitive sport teaches resilience, teamwork, and how to handle winning and losing with grace â€” all genuinely valuable life skills. But when winning becomes the only measure of success, sport can cause real psychological harm, particularly for young people. The difference usually comes down to the adults involved â€” coaches and parents who can keep things in perspective.`,
    },
    'family together': {
      task: `Here are your two photographs. They both relate to family life, though they seem to capture it in quite different ways. I'd like you to compare and contrast these photographs, and say how you think family life has changed in recent years.`,
      question2nd: `Do you think it is harder to maintain strong family relationships today than it was in the past?`,
      answer2nd: `In some ways yes, in others no. Physical distance, busy schedules, and the constant pull of digital devices do create real challenges for family time. But technology also allows families separated by geography to stay genuinely connected in ways that weren't possible before. I think the deeper issue is intention: strong family relationships have always required deliberate effort. The pressures may have changed, but the fundamental need to prioritise those relationships hasn't.`,
    },
    'city urban life': {
      task: `Here are your two photographs. They both relate to city and urban life, but they seem to show quite different sides of it. I'd like you to compare and contrast these photographs, and say what you think makes a city a genuinely good place to live.`,
      question2nd: `Do you think living in a city is better or worse for quality of life than living in the countryside?`,
      answer2nd: `Neither is universally better â€” it really depends on what you value most. Cities offer variety, career opportunities, cultural richness, and social diversity that are hard to replicate elsewhere. The countryside offers space, quiet, strong community, and a closer connection to nature. What the evidence does consistently suggest is that access to green space is crucial wherever you live, and that cities which invest in parks and walkable streets genuinely improve residents' wellbeing and sense of belonging.`,
    },
    'social media smartphone': {
      task: `Here are your two photographs. They both relate to social media and smartphones, but they approach the subject from different angles. I'd like you to compare and contrast these photographs, and say how you think social media has changed the way people communicate.`,
      question2nd: `Do you think young people today are more or less socially connected than previous generations?`,
      answer2nd: `More connected in quantity, but often less so in quality. Young people today maintain far larger networks and communicate constantly, but much of that interaction is shallow â€” likes, short videos, and curated highlights rather than genuine dialogue. Real connection requires vulnerability and presence, which are harder to cultivate online. That said, for young people in marginalised or isolated communities, social media can be a genuine lifeline for finding belonging and shared identity.`,
    },
    'art culture museum': {
      task: `Here are your two photographs. They both connect to art and culture, but they represent it in quite different ways. I'd like you to compare and contrast these photographs, and say how important you think art and culture are in people's everyday lives.`,
      question2nd: `Do you think art and culture should receive public funding, or should they be self-sustaining through the market?`,
      answer2nd: `I strongly believe public funding is essential. Much of the art with the greatest long-term cultural value â€” experimental theatre, contemporary music, regional museums, independent film â€” simply could not survive on commercial terms alone. Public funding allows culture to take risks, serve communities rather than just consumers, and preserve heritage that would otherwise be lost entirely. The arts also generate significant economic and social value that is not reflected in box office figures or ticket sales.`,
    },
  };

  const EXAMINER_PROMPT_FALLBACK = {
    task: `Here are your two photographs. They seem to share a common theme, though they approach it from quite different angles. I'd like you to compare and contrast the two images, and say what you find most interesting about the differences between them.`,
    question2nd: `Which of the two photographs do you find more thought-provoking, and why?`,
    answer2nd: `I find the second photograph more thought-provoking, because it raises questions that the first one answers a little too neatly. The first has a clarity of mood and composition that's satisfying but somewhat closed. The second feels more ambiguous â€” it invites you to bring your own interpretation. And in my experience, the images that stay with you are usually the ones that don't quite resolve: those that leave something open for the viewer to complete themselves.`,
  };

  function getExaminerPrompt(topic) {
    return (topic && EXAMINER_PROMPTS[topic.query]) ? EXAMINER_PROMPTS[topic.query] : EXAMINER_PROMPT_FALLBACK;
  }

  function generateSpeech(topic) {
    return (topic && SPEECHES[topic.query]) ? SPEECHES[topic.query] : SPEECH_FALLBACK;
  }

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let secondChosen          = [];
  let appSpeechText         = '';
  let appSpeechSeconds      = 0;
  let secondUserSeconds     = 0;
  let secondTimerInterval   = null;
  let secondMicStream       = null;
  let secondMediaRecorder   = null;
  let secondAudioChunks     = [];
  let secondFinalTranscript = '';
  let secondRecognition     = null;
  let currentUtterance      = null;

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const listenTimerRing     = document.getElementById('listen-timer-ring');
  const listenTimerText     = document.getElementById('listen-timer-text');
  const listenTranscriptBox = document.getElementById('listen-transcript-box');
  const secondTimerRing     = document.getElementById('second-timer-ring');
  const secondTimerText     = document.getElementById('second-timer-text');
  const secondTranscriptFinal   = document.getElementById('second-transcript-final');
  const secondTranscriptInterim = document.getElementById('second-transcript-interim');
  const secondTranscriptBox     = document.getElementById('second-transcript-box');

  // â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('listening-back-btn').addEventListener('click', () => {
    stopAppSpeech();
    showOnly('role-section');
  });

  document.getElementById('listen-skip-btn').addEventListener('click', () => {
    stopAppSpeech();
    showExaminerQuestion2nd();
  });

  document.getElementById('second-stop-btn').addEventListener('click', () => {
    stopUserSpeaking(true);
  });

  document.getElementById('second-restart-btn').addEventListener('click', () => showOnly('mode-section'));
  document.getElementById('second-download-btn').addEventListener('click', downloadSecondResult);

  // â”€â”€ Entry point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startSecondCandidateActivity(images) {
    secondChosen     = images;
    appSpeechText    = generateSpeech(currentTopic);
    appSpeechSeconds = 0;

    // Populate listening images
    const listeningImages = document.getElementById('listening-images');
    listeningImages.innerHTML = '';
    images.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      listeningImages.appendChild(div);
    });

    listenTranscriptBox.textContent = '';
    listenTimerRing.style.stroke = '#4299e1';
    listenTimerRing.style.strokeDashoffset = CIRCUMFERENCE;
    listenTimerText.textContent = '0:00';

    showOnly('second-listening-section');
    startAppSpeech();
  }

  // â”€â”€ App speaking (TTS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startAppSpeech() {
    if (!window.speechSynthesis) {
      listenTranscriptBox.textContent = appSpeechText + '\n\n(Text-to-speech not supported in this browser â€” read the transcript above and click Skip when ready.)';
      return;
    }

    // Timer counting up
    secondTimerInterval = setInterval(() => {
      appSpeechSeconds++;
      const progress = Math.min(appSpeechSeconds / SECOND_LISTEN_LIMIT, 1);
      listenTimerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - progress);
      const m = Math.floor(appSpeechSeconds / 60);
      const s = appSpeechSeconds % 60;
      listenTimerText.textContent = `${m}:${s.toString().padStart(2, '0')}`;
    }, 1000);

    currentUtterance = new SpeechSynthesisUtterance(appSpeechText);
    currentUtterance.lang = 'en-GB';
    currentUtterance.rate = 0.95;

    // Pick best voice
    const assignVoice = () => {
      const voices = window.speechSynthesis.getVoices();
      const voice  = voices.find(v => v.lang === 'en-GB' && v.name.toLowerCase().includes('google'))
                  || voices.find(v => v.lang === 'en-GB')
                  || voices.find(v => v.lang.startsWith('en'));
      if (voice) currentUtterance.voice = voice;
    };

    if (window.speechSynthesis.getVoices().length) {
      assignVoice();
    } else {
      window.speechSynthesis.onvoiceschanged = () => { assignVoice(); window.speechSynthesis.onvoiceschanged = null; };
    }

    // Word-by-word transcript reveal
    currentUtterance.onboundary = (e) => {
      if (e.name === 'word') {
        const revealed = appSpeechText.slice(0, e.charIndex + (e.charLength || 1));
        listenTranscriptBox.textContent = revealed;
        listenTranscriptBox.scrollTop = listenTranscriptBox.scrollHeight;
      }
    };

    currentUtterance.onend = () => {
      clearInterval(secondTimerInterval);
      secondTimerInterval = null;
      listenTranscriptBox.textContent = appSpeechText;
      setTimeout(() => showExaminerQuestion2nd(), 1500);
    };

    currentUtterance.onerror = (e) => {
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      console.warn('TTS error:', e.error);
      clearInterval(secondTimerInterval);
      secondTimerInterval = null;
      listenTranscriptBox.textContent = appSpeechText;
      showExaminerQuestion2nd();
    };

    window.speechSynthesis.speak(currentUtterance);
  }

  function stopAppSpeech() {
    clearInterval(secondTimerInterval);
    secondTimerInterval = null;
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    currentUtterance = null;
  }

  // â”€â”€ User speaking (record + transcribe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startUserSpeaking() {
    secondUserSeconds     = 0;
    secondFinalTranscript = '';
    secondAudioChunks     = [];
    secondTranscriptFinal.textContent   = '';
    secondTranscriptInterim.textContent = '';

    // Populate images
    const speakingImages = document.getElementById('second-speaking-images');
    speakingImages.innerHTML = '';
    secondChosen.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      speakingImages.appendChild(div);
    });

    // Reset timer display
    secondTimerRing.style.stroke = '#48bb78';
    secondTimerRing.style.strokeDashoffset = CIRCUMFERENCE;
    secondTimerText.style.fill  = '#2d3748';
    secondTimerText.textContent = '0:30';

    const secondError = document.getElementById('second-speaking-error');
    secondError.style.display = 'none';

    showOnly('second-speaking-section');

    // Microphone
    try {
      secondMicStream       = await navigator.mediaDevices.getUserMedia({ audio: true });
      secondMediaRecorder   = new MediaRecorder(secondMicStream);
      secondMediaRecorder.ondataavailable = e => secondAudioChunks.push(e.data);
      secondMediaRecorder.start();
    } catch (err) {
      secondError.textContent = `Microphone error: ${err.message} â€” please allow microphone access and try again.`;
      secondError.style.display = 'block';
    }

    // Speech recognition
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
      secondRecognition = new SR();
      secondRecognition.lang = 'en-GB';
      secondRecognition.continuous = true;
      secondRecognition.interimResults = true;

      secondRecognition.onresult = (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) secondFinalTranscript += e.results[i][0].transcript + ' ';
          else interim += e.results[i][0].transcript;
        }
        secondTranscriptFinal.textContent   = secondFinalTranscript;
        secondTranscriptInterim.textContent = interim;
        secondTranscriptBox.scrollTop = secondTranscriptBox.scrollHeight;
      };

      secondRecognition.onerror = (e) => {
        if (e.error === 'aborted') return;
        secondError.textContent = `Transcription error: "${e.error}". Try Chrome or Edge, and ensure the page is served over HTTPS or localhost.`;
        secondError.style.display = 'block';
      };

      secondRecognition.onend = () => { if (secondTimerInterval) secondRecognition.start(); };
      secondRecognition.start();
    } else {
      secondTranscriptFinal.textContent = '(Speech recognition not supported â€” use Chrome or Edge)';
    }

    // Countdown timer
    secondTimerInterval = setInterval(() => {
      secondUserSeconds++;
      updateSecondUserTimer();
      if (secondUserSeconds >= SECOND_SPEAK_LIMIT) stopUserSpeaking(true);
    }, 1000);
  }

  function updateSecondUserTimer() {
    const remaining = Math.max(SECOND_SPEAK_LIMIT - secondUserSeconds, 0);
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    secondTimerText.textContent = `${m}:${s.toString().padStart(2, '0')}`;

    const progress = Math.min(secondUserSeconds / SECOND_SPEAK_LIMIT, 1);
    secondTimerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - progress);

    if (secondUserSeconds >= SECOND_SPEAK_LIMIT) {
      secondTimerRing.style.stroke = '#fc8181';
      secondTimerText.style.fill   = '#e53e3e';
    } else if (secondUserSeconds >= SECOND_SPEAK_LIMIT * 0.8) {
      secondTimerRing.style.stroke = '#f6ad55';
      secondTimerText.style.fill   = '#dd6b20';
    }
  }

  function stopUserSpeaking(showResult) {
    clearInterval(secondTimerInterval);
    secondTimerInterval = null;

    if (secondRecognition) {
      secondRecognition.onend = null;
      secondRecognition.stop();
      secondRecognition = null;
    }
    secondTranscriptInterim.textContent = '';

    if (secondMediaRecorder && secondMediaRecorder.state !== 'inactive') {
      secondMediaRecorder.stop();
      secondMediaRecorder = null;
    }
    if (secondMicStream) {
      secondMicStream.getTracks().forEach(t => t.stop());
      secondMicStream = null;
    }

    if (showResult) showSecondResult();
  }

  // â”€â”€ Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showSecondResult() {
    const userText   = secondFinalTranscript.trim() || '(No speech detected)';
    const appDur     = `${Math.floor(appSpeechSeconds / 60)}:${String(appSpeechSeconds % 60).padStart(2, '0')}`;
    const userDur    = `${Math.floor(secondUserSeconds / 60)}:${String(secondUserSeconds % 60).padStart(2, '0')}`;
    const date       = new Date().toISOString();
    const topicLabel = currentTopic ? currentTopic.label : 'Custom images';

    document.getElementById('second-app-transcript-text').textContent = appSpeechText;
    document.getElementById('second-user-transcript-text').textContent = userText;
    document.getElementById('second-app-duration').textContent  = appDur;
    document.getElementById('second-user-duration').textContent = userDur;

    const STORAGE_KEY = 'c1_transcripts';
    const entry = { date, role: '2nd', topic: topicLabel, appDuration: appDur, appTranscript: appSpeechText, userDuration: userDur, userTranscript: userText };
    try {
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      existing.push(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
      document.getElementById('second-saved-badge').style.display = 'inline-block';
    } catch (e) {
      console.warn('Could not save to localStorage:', e);
    }

    showOnly('second-result-section');
  }

  function downloadSecondResult() {
    const appText    = document.getElementById('second-app-transcript-text').textContent;
    const userText   = document.getElementById('second-user-transcript-text').textContent;
    const appDur     = document.getElementById('second-app-duration').textContent;
    const userDur    = document.getElementById('second-user-duration').textContent;
    const date       = new Date().toISOString();
    const topicLabel = currentTopic ? currentTopic.label : 'Custom images';

    const content = [
      `C1 Speaking Test \u2013 Part 2 (2nd Candidate)`,
      `Date:  ${new Date(date).toLocaleString()}`,
      `Topic: ${topicLabel}`,
      ``,
      `\u2500\u2500\u2500 1st Candidate (App) \u2014 Duration: ${appDur} \u2500\u2500\u2500`,
      appText,
      ``,
      `\u2500\u2500\u2500 2nd Candidate (You) \u2014 Duration: ${userDur} \u2500\u2500\u2500`,
      userText,
    ].join('\n');

    const blob = new Blob([content], { type: 'text/plain' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `c1_2nd_candidate_${date.slice(0, 10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXAMINER PROMPT 2ND SECTION  (â‘¤-A â€” 2nd Candidate scenario)
  // Examiner reads the task to the 1st candidate (app); user watches.
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let secondCandidateImages = [];

  const ep2TimerRing   = document.getElementById('ep2-timer-ring');
  const ep2TimerText   = document.getElementById('ep2-timer-text');
  const ep2PromptBox   = document.getElementById('ep2-prompt-box');
  const ep2ContinueBtn = document.getElementById('ep2-continue-btn');

  let ep2Utterance     = null;
  let ep2TimerInterval = null;
  let ep2Seconds       = 0;

  document.getElementById('ep2-back-btn').addEventListener('click', () => {
    stopEp2Speech();
    showOnly('role-section');
  });

  document.getElementById('ep2-skip-btn').addEventListener('click', () => {
    stopEp2Speech();
    ep2PromptBox.textContent = getExaminerPrompt(currentTopic).task;
    revealEp2ContinueBtn();
  });

  ep2ContinueBtn.addEventListener('click', () => {
    startSecondCandidateActivity(secondCandidateImages);
  });

  function showExaminerPrompt2nd(images) {
    secondCandidateImages = images;
    const data = getExaminerPrompt(currentTopic);

    const ep2Images = document.getElementById('ep2-images');
    ep2Images.innerHTML = '';
    images.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      ep2Images.appendChild(div);
    });

    ep2Seconds = 0;
    ep2PromptBox.textContent = '';
    ep2TimerRing.style.strokeDashoffset = CIRCUMFERENCE;
    ep2TimerRing.style.stroke = '#4299e1';
    ep2TimerText.textContent = '0:00';
    ep2ContinueBtn.classList.add('hidden');
    document.getElementById('ep2-controls').style.display = '';
    document.getElementById('ep2-skip-btn').style.display = '';
    document.querySelector('#examiner-prompt-2nd-section .speaking-header').style.display = '';

    showOnly('examiner-prompt-2nd-section');
    startEp2Speech(data.task);
  }

  function startEp2Speech(text) {
    if (!window.speechSynthesis) {
      ep2PromptBox.textContent = text + '\n\n(Text-to-speech not supported â€” read the prompt above and click Skip.)';
      revealEp2ContinueBtn();
      return;
    }

    ep2TimerInterval = setInterval(() => {
      ep2Seconds++;
      const m = Math.floor(ep2Seconds / 60);
      const s = ep2Seconds % 60;
      ep2TimerText.textContent = `${m}:${s.toString().padStart(2, '0')}`;
      ep2TimerRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - Math.min(ep2Seconds / 60, 1));
    }, 1000);

    ep2Utterance = new SpeechSynthesisUtterance(text);
    ep2Utterance.lang = 'en-GB';
    ep2Utterance.rate = 0.95;

    const assignVoice = () => {
      const voices = window.speechSynthesis.getVoices();
      const voice  = voices.find(v => v.lang === 'en-GB' && v.name.toLowerCase().includes('google'))
                  || voices.find(v => v.lang === 'en-GB')
                  || voices.find(v => v.lang.startsWith('en'));
      if (voice) ep2Utterance.voice = voice;
    };
    if (window.speechSynthesis.getVoices().length) assignVoice();
    else window.speechSynthesis.onvoiceschanged = () => { assignVoice(); window.speechSynthesis.onvoiceschanged = null; };

    ep2Utterance.onboundary = (e) => {
      if (e.name === 'word') {
        ep2PromptBox.textContent = text.slice(0, e.charIndex + (e.charLength || 1));
        ep2PromptBox.scrollTop = ep2PromptBox.scrollHeight;
      }
    };
    ep2Utterance.onend = () => {
      clearInterval(ep2TimerInterval); ep2TimerInterval = null;
      ep2PromptBox.textContent = text;
      revealEp2ContinueBtn();
    };
    ep2Utterance.onerror = (e) => {
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      clearInterval(ep2TimerInterval); ep2TimerInterval = null;
      ep2PromptBox.textContent = text;
      revealEp2ContinueBtn();
    };

    window.speechSynthesis.speak(ep2Utterance);
  }

  function stopEp2Speech() {
    clearInterval(ep2TimerInterval); ep2TimerInterval = null;
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    ep2Utterance = null;
  }

  function revealEp2ContinueBtn() {
    document.getElementById('ep2-controls').style.display = 'none';
    ep2ContinueBtn.classList.remove('hidden');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXAMINER QUESTION 2ND SECTION  (â‘©-A â€” before user speaks)
  // Examiner addresses the 2nd Candidate (user) with a brief question.
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const eq2QuestionBox = document.getElementById('eq2-question-box');
  const eq2StartBtn    = document.getElementById('eq2-start-btn');

  let eq2Utterance = null;

  document.getElementById('eq2-skip-btn').addEventListener('click', () => {
    stopEq2Speech();
    eq2QuestionBox.textContent = 'Thank you. ' + getExaminerPrompt(currentTopic).question2nd;
    revealEq2StartBtn();
  });

  eq2StartBtn.addEventListener('click', () => {
    startUserSpeaking();
  });

  function showExaminerQuestion2nd() {
    const data = getExaminerPrompt(currentTopic);
    const questionText = 'Thank you. ' + data.question2nd;

    const eq2Images = document.getElementById('eq2-images');
    eq2Images.innerHTML = '';
    secondCandidateImages.forEach((img, i) => {
      const div = document.createElement('div');
      div.className = 'activity-img';
      div.innerHTML = `<img src="${img.src}" alt="Image ${i + 1}" />
        ${img.creditHtml ? `<div class="credit">${img.creditHtml}</div>` : ''}`;
      eq2Images.appendChild(div);
    });

    eq2QuestionBox.textContent = '';
    eq2StartBtn.classList.add('hidden');
    document.getElementById('eq2-controls').style.display = '';
    document.getElementById('eq2-skip-btn').style.display = '';
    document.querySelector('#examiner-question-2nd-section .speaking-header').style.display = '';

    showOnly('examiner-question-2nd-section');
    startEq2Speech(questionText);
  }

  function startEq2Speech(text) {
    if (!window.speechSynthesis) {
      eq2QuestionBox.textContent = text + '\n\n(Text-to-speech not supported â€” read the question above and click Skip.)';
      revealEq2StartBtn();
      return;
    }

    eq2Utterance = new SpeechSynthesisUtterance(text);
    eq2Utterance.lang = 'en-GB';
    eq2Utterance.rate = 0.95;

    const assignVoice = () => {
      const voices = window.speechSynthesis.getVoices();
      const voice  = voices.find(v => v.lang === 'en-GB' && v.name.toLowerCase().includes('google'))
                  || voices.find(v => v.lang === 'en-GB')
                  || voices.find(v => v.lang.startsWith('en'));
      if (voice) eq2Utterance.voice = voice;
    };
    if (window.speechSynthesis.getVoices().length) assignVoice();
    else window.speechSynthesis.onvoiceschanged = () => { assignVoice(); window.speechSynthesis.onvoiceschanged = null; };

    eq2Utterance.onboundary = (e) => {
      if (e.name === 'word') {
        eq2QuestionBox.textContent = text.slice(0, e.charIndex + (e.charLength || 1));
      }
    };
    eq2Utterance.onend = () => {
      eq2QuestionBox.textContent = text;
      revealEq2StartBtn();
    };
    eq2Utterance.onerror = (e) => {
      if (e.error === 'interrupted' || e.error === 'canceled') return;
      eq2QuestionBox.textContent = text;
      revealEq2StartBtn();
    };

    window.speechSynthesis.speak(eq2Utterance);
  }

  function stopEq2Speech() {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    eq2Utterance = null;
  }

  function revealEq2StartBtn() {
    document.getElementById('eq2-controls').style.display = 'none';
    eq2StartBtn.classList.remove('hidden');
  }
</script>
</body>
</html>
